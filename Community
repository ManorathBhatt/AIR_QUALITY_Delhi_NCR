import React, { useState, useEffect } from "react";
import { CommunityReport } from "@/entities/all";
import { User } from "@/entities/User";
import { UploadFile } from "@/integrations/Core";
import { motion } from "framer-motion";
import { Users, Plus, MapPin, Camera, ThumbsUp, ThumbsDown, MessageSquare, Filter, Eye, Award, Flame, Factory, Truck, Building2, AlertTriangle } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { formatDistanceToNow } from "date-fns";

const reportTypeIcons = {
    stubble_burning: { icon: Flame, color: "text-orange-500" },
    garbage_fire: { icon: Flame, color: "text-red-500" },
    industrial_smoke: { icon: Factory, color: "text-purple-500" },
    construction_dust: { icon: Building2, color: "text-yellow-500" },
    vehicle_emission: { icon: Truck, color: "text-blue-500" },
    illegal_burning: { icon: AlertTriangle, color: "text-red-600" },
    other: { icon: AlertTriangle, color: "text-gray-500" }
};

const severityColors = {
    low: "bg-green-500/10 text-green-400 border-green-500/20",
    medium: "bg-yellow-500/10 text-yellow-400 border-yellow-500/20", 
    high: "bg-orange-500/10 text-orange-400 border-orange-500/20",
    critical: "bg-red-500/10 text-red-400 border-red-500/20"
};

const statusColors = {
    pending: "bg-yellow-500/10 text-yellow-400",
    verified: "bg-green-500/10 text-green-400",
    investigating: "bg-blue-500/10 text-blue-400",
    resolved: "bg-emerald-500/10 text-emerald-400",
    rejected: "bg-red-500/10 text-red-400"
};

export default function CommunityPage() {
    const [reports, setReports] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState("all");
    const [showReportDialog, setShowReportDialog] = useState(false);
    const [newReport, setNewReport] = useState({
        report_type: "",
        title: "",
        description: "",
        location: { latitude: null, longitude: null, address: "", landmark: "" },
        severity: "medium",
        image_urls: [],
        is_anonymous: false,
        tags: []
    });
    const [uploadingImage, setUploadingImage] = useState(false);
    const [currentUser, setCurrentUser] = useState(null);

    useEffect(() => {
        fetchReports();
        getCurrentUser();
        getCurrentLocation();
    }, []);

    const getCurrentUser = async () => {
        try {
            const user = await User.me();
            setCurrentUser(user);
        } catch (error) {
            console.error("Error getting current user:", error);
        }
    };

    const getCurrentLocation = () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setNewReport(prev => ({
                        ...prev,
                        location: {
                            ...prev.location,
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        }
                    }));
                },
                (error) => {
                    console.log("Location access denied");
                }
            );
        }
    };

    const fetchReports = async () => {
        try {
            const data = await CommunityReport.list("-created_date", 20);
            setReports(data || []);
        } catch (error) {
            console.error("Error fetching reports:", error);
        }
        setLoading(false);
    };

    const handleImageUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        setUploadingImage(true);
        try {
            const result = await UploadFile({ file });
            setNewReport(prev => ({
                ...prev,
                image_urls: [...prev.image_urls, result.file_url]
            }));
        } catch (error) {
            console.error("Error uploading image:", error);
        }
        setUploadingImage(false);
    };

    const handleSubmitReport = async () => {
        try {
            await CommunityReport.create({
                ...newReport,
                points_awarded: 10 // Award points for reporting
            });
            setShowReportDialog(false);
            setNewReport({
                report_type: "",
                title: "",
                description: "",
                location: { latitude: null, longitude: null, address: "", landmark: "" },
                severity: "medium",
                image_urls: [],
                is_anonymous: false,
                tags: []
            });
            fetchReports();
        } catch (error) {
            console.error("Error submitting report:", error);
        }
    };

    const handleVote = async (reportId, voteType) => {
        try {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;

            const updatedReport = {
                ...report,
                [voteType]: (report[voteType] || 0) + 1
            };

            await CommunityReport.update(reportId, updatedReport);
            fetchReports();
        } catch (error) {
            console.error("Error voting:", error);
        }
    };

    const filteredReports = reports.filter(report => {
        if (filter === "all") return true;
        if (filter === "my_reports") return report.created_by === currentUser?.email;
        return report.report_type === filter;
    });

    return (
        <motion.div 
            className="p-4 md:p-6 lg:p-8 space-y-6"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
        >
            {/* Header */}
            <motion.div 
                className="flex flex-col md:flex-row justify-between md:items-center gap-4"
                initial={{ y: -20 }}
                animate={{ y: 0 }}
            >
                <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-foreground flex items-center gap-3">
                        <Users className="w-8 h-8 text-emerald-500" />
                        Community Reports
                    </h1>
                    <p className="text-muted-foreground mt-1">Report pollution incidents and help keep your community clean</p>
                </div>
                
                <Dialog open={showReportDialog} onOpenChange={setShowReportDialog}>
                    <DialogTrigger asChild>
                        <Button className="bg-gradient-to-r from-emerald-500 to-cyan-600">
                            <Plus className="w-5 h-5 mr-2" />
                            New Report
                        </Button>
                    </DialogTrigger>
                    <DialogContent className="max-w-md max-h-[90vh] overflow-y-auto">
                        <DialogHeader>
                            <DialogTitle>Report Pollution Incident</DialogTitle>
                        </DialogHeader>
                        <div className="space-y-4">
                            <div>
                                <Label htmlFor="report-type">Type of Pollution</Label>
                                <Select value={newReport.report_type} onValueChange={(value) => setNewReport(prev => ({...prev, report_type: value}))}>
                                    <SelectTrigger>
                                        <SelectValue placeholder="Select pollution type" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="stubble_burning">Stubble Burning</SelectItem>
                                        <SelectItem value="garbage_fire">Garbage Fire</SelectItem>
                                        <SelectItem value="industrial_smoke">Industrial Smoke</SelectItem>
                                        <SelectItem value="construction_dust">Construction Dust</SelectItem>
                                        <SelectItem value="vehicle_emission">Vehicle Emission</SelectItem>
                                        <SelectItem value="illegal_burning">Illegal Burning</SelectItem>
                                        <SelectItem value="other">Other</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>

                            <div>
                                <Label htmlFor="title">Title</Label>
                                <Input
                                    id="title"
                                    value={newReport.title}
                                    onChange={(e) => setNewReport(prev => ({...prev, title: e.target.value}))}
                                    placeholder="Brief description of the incident"
                                />
                            </div>

                            <div>
                                <Label htmlFor="description">Description</Label>
                                <Textarea
                                    id="description"
                                    value={newReport.description}
                                    onChange={(e) => setNewReport(prev => ({...prev, description: e.target.value}))}
                                    placeholder="Detailed description of what you observed"
                                    className="h-20"
                                />
                            </div>

                            <div>
                                <Label htmlFor="severity">Severity Level</Label>
                                <Select value={newReport.severity} onValueChange={(value) => setNewReport(prev => ({...prev, severity: value}))}>
                                    <SelectTrigger>
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="low">Low</SelectItem>
                                        <SelectItem value="medium">Medium</SelectItem>
                                        <SelectItem value="high">High</SelectItem>
                                        <SelectItem value="critical">Critical</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>

                            <div>
                                <Label htmlFor="landmark">Landmark (Optional)</Label>
                                <Input
                                    id="landmark"
                                    value={newReport.location.landmark}
                                    onChange={(e) => setNewReport(prev => ({
                                        ...prev, 
                                        location: {...prev.location, landmark: e.target.value}
                                    }))}
                                    placeholder="Nearby landmark or specific location"
                                />
                            </div>

                            <div>
                                <Label>Upload Photo/Video</Label>
                                <div className="flex items-center gap-2">
                                    <input
                                        type="file"
                                        accept="image/*,video/*"
                                        onChange={handleImageUpload}
                                        className="hidden"
                                        id="image-upload"
                                    />
                                    <Label htmlFor="image-upload" className="cursor-pointer">
                                        <Button type="button" variant="outline" disabled={uploadingImage}>
                                            <Camera className="w-4 h-4 mr-2" />
                                            {uploadingImage ? "Uploading..." : "Add Media"}
                                        </Button>
                                    </Label>
                                    {newReport.image_urls.length > 0 && (
                                        <Badge variant="secondary">{newReport.image_urls.length} files</Badge>
                                    )}
                                </div>
                            </div>

                            <div className="flex items-center space-x-2">
                                <Switch
                                    id="anonymous"
                                    checked={newReport.is_anonymous}
                                    onCheckedChange={(checked) => setNewReport(prev => ({...prev, is_anonymous: checked}))}
                                />
                                <Label htmlFor="anonymous">Report anonymously</Label>
                            </div>

                            <div className="flex gap-2 pt-4">
                                <Button onClick={handleSubmitReport} disabled={!newReport.report_type || !newReport.title} className="flex-1">
                                    Submit Report
                                </Button>
                                <Button variant="outline" onClick={() => setShowReportDialog(false)}>
                                    Cancel
                                </Button>
                            </div>
                        </div>
                    </DialogContent>
                </Dialog>
            </motion.div>

            {/* Filter Tabs */}
            <Tabs value={filter} onValueChange={setFilter}>
                <TabsList className="grid grid-cols-3 md:grid-cols-6 w-full">
                    <TabsTrigger value="all">All</TabsTrigger>
                    <TabsTrigger value="my_reports">My Reports</TabsTrigger>
                    <TabsTrigger value="stubble_burning">Stubble</TabsTrigger>
                    <TabsTrigger value="industrial_smoke">Industry</TabsTrigger>
                    <TabsTrigger value="garbage_fire">Garbage</TabsTrigger>
                    <TabsTrigger value="vehicle_emission">Vehicle</TabsTrigger>
                </TabsList>

                <TabsContent value={filter} className="mt-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {loading ? (
                            Array(6).fill(0).map((_, i) => (
                                <div key={i} className="h-64 bg-card rounded-lg animate-pulse" />
                            ))
                        ) : filteredReports.length > 0 ? (
                            filteredReports.map((report, index) => (
                                <ReportCard
                                    key={report.id}
                                    report={report}
                                    onVote={handleVote}
                                    index={index}
                                />
                            ))
                        ) : (
                            <div className="col-span-full text-center py-12">
                                <Users className="mx-auto h-16 w-16 text-muted-foreground/50 mb-4" />
                                <p className="text-muted-foreground text-lg">No reports found</p>
                                <p className="text-sm text-muted-foreground mt-2">Be the first to report pollution in your area!</p>
                            </div>
                        )}
                    </div>
                </TabsContent>
            </Tabs>
        </motion.div>
    );
}

function ReportCard({ report, onVote, index }) {
    const reportType = reportTypeIcons[report.report_type] || reportTypeIcons.other;
    const IconComponent = reportType.icon;

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: index * 0.1 }}
        >
            <Card className="hover:shadow-lg transition-shadow cursor-pointer">
                <CardHeader className="pb-3">
                    <div className="flex items-start justify-between">
                        <div className="flex items-center gap-2">
                            <IconComponent className={`w-5 h-5 ${reportType.color}`} />
                            <Badge className={severityColors[report.severity]}>
                                {report.severity.toUpperCase()}
                            </Badge>
                        </div>
                        <Badge className={statusColors[report.status]}>
                            {report.status}
                        </Badge>
                    </div>
                    <CardTitle className="text-lg line-clamp-2">{report.title}</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                    <p className="text-sm text-muted-foreground line-clamp-3">{report.description}</p>
                    
                    {report.image_urls && report.image_urls.length > 0 && (
                        <div className="flex gap-2">
                            {report.image_urls.slice(0, 2).map((url, i) => (
                                <img 
                                    key={i}
                                    src={url} 
                                    alt="Report evidence" 
                                    className="w-16 h-16 object-cover rounded-lg" 
                                />
                            ))}
                            {report.image_urls.length > 2 && (
                                <div className="w-16 h-16 bg-muted rounded-lg flex items-center justify-center text-sm">
                                    +{report.image_urls.length - 2}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="flex items-center gap-4 text-sm text-muted-foreground">
                        <div className="flex items-center gap-1">
                            <MapPin className="w-4 h-4" />
                            <span>{report.location?.landmark || "Location provided"}</span>
                        </div>
                        <div className="flex items-center gap-1">
                            <Eye className="w-4 h-4" />
                            <span>{report.verification_score || 0}% verified</span>
                        </div>
                    </div>

                    <div className="flex items-center justify-between pt-2 border-t border-border">
                        <div className="flex items-center gap-3">
                            <Button 
                                variant="ghost" 
                                size="sm" 
                                onClick={() => onVote(report.id, 'upvotes')}
                                className="flex items-center gap-1 hover:text-green-500"
                            >
                                <ThumbsUp className="w-4 h-4" />
                                <span>{report.upvotes || 0}</span>
                            </Button>
                            <Button 
                                variant="ghost" 
                                size="sm" 
                                onClick={() => onVote(report.id, 'downvotes')}
                                className="flex items-center gap-1 hover:text-red-500"
                            >
                                <ThumbsDown className="w-4 h-4" />
                                <span>{report.downvotes || 0}</span>
                            </Button>
                            <Button variant="ghost" size="sm" className="flex items-center gap-1">
                                <MessageSquare className="w-4 h-4" />
                                <span>{report.comments?.length || 0}</span>
                            </Button>
                        </div>
                        
                        <div className="text-xs text-muted-foreground">
                            {formatDistanceToNow(new Date(report.created_date), { addSuffix: true })}
                        </div>
                    </div>

                    {report.points_awarded > 0 && (
                        <div className="flex items-center gap-1 text-xs text-emerald-500">
                            <Award className="w-3 h-3" />
                            <span>+{report.points_awarded} points awarded</span>
                        </div>
                    )}
                </CardContent>
            </Card>
        </motion.div>
    );
}