import React, { useState, useEffect } from "react";
import { UserProfile } from "@/entities/UserProfile";
import { User } from "@/entities/User";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { UserPlus, ShieldPlus } from "lucide-react";

const healthConditionsOptions = [
    { id: 'asthma', label: 'Asthma' },
    { id: 'heart_disease', label: 'Heart Disease' },
    { id: 'diabetes', label: 'Diabetes' },
    { id: 'respiratory_issues', label: 'Other Respiratory Issues' },
    { id: 'pregnancy', label: 'Pregnancy' },
    { id: 'chronic_illness', label: 'Chronic Illness' }
];

export default function ProfileSetupForm({ existingProfile, onProfileSaved }) {
    const [profile, setProfile] = useState(existingProfile || {
        full_name: '',
        age: '',
        gender: '',
        health_conditions: [],
        activity_level: 'moderate',
    });
    const [currentUser, setCurrentUser] = useState(null);
    const [loading, setLoading] = useState(false);
    
    useEffect(() => {
        const fetchUser = async () => {
            try {
                const user = await User.me();
                setCurrentUser(user);
                if (!existingProfile) {
                    setProfile(p => ({ ...p, full_name: user.full_name }));
                }
            } catch (e) { console.error(e) }
        };
        fetchUser();
    }, [existingProfile]);

    const handleHealthConditionChange = (conditionId) => {
        setProfile(prev => {
            const newConditions = prev.health_conditions.includes(conditionId)
                ? prev.health_conditions.filter(c => c !== conditionId)
                : [...prev.health_conditions, conditionId];
            return { ...prev, health_conditions: newConditions };
        });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            let savedProfile;
            const profileData = {
                ...profile,
                age: Number(profile.age)
            };
            
            if (existingProfile && existingProfile.id) {
                savedProfile = await UserProfile.update(existingProfile.id, profileData);
            } else {
                savedProfile = await UserProfile.create(profileData);
            }
            onProfileSaved(savedProfile);
        } catch (error) {
            console.error("Error saving profile:", error);
        }
        setLoading(false);
    };

    return (
        <motion.div 
            className="flex items-center justify-center min-h-screen bg-background p-4"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
        >
            <Card className="w-full max-w-lg shadow-2xl">
                <CardHeader className="text-center">
                    <ShieldPlus className="w-12 h-12 mx-auto text-emerald-500" />
                    <CardTitle className="text-2xl mt-2">
                        {existingProfile ? "Update Your Health Profile" : "Create Your Health Profile"}
                    </CardTitle>
                    <CardDescription>
                        This helps us provide personalized air quality alerts and health recommendations.
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <Label htmlFor="full_name">Full Name</Label>
                                <Input id="full_name" value={profile.full_name} onChange={(e) => setProfile(p => ({...p, full_name: e.target.value}))} required />
                            </div>
                            <div>
                                <Label htmlFor="age">Age</Label>
                                <Input id="age" type="number" value={profile.age} onChange={(e) => setProfile(p => ({...p, age: e.target.value}))} required />
                            </div>
                        </div>
                        
                        <div>
                            <Label htmlFor="gender">Gender</Label>
                            <Select value={profile.gender} onValueChange={(value) => setProfile(p => ({...p, gender: value}))}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Select gender" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="male">Male</SelectItem>
                                    <SelectItem value="female">Female</SelectItem>
                                    <SelectItem value="other">Other</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>
                        
                        <div>
                            <Label>Pre-existing Health Conditions (select all that apply)</Label>
                            <div className="grid grid-cols-2 gap-2 mt-2">
                                {healthConditionsOptions.map(condition => (
                                    <div key={condition.id} className="flex items-center space-x-2">
                                        <Checkbox 
                                            id={condition.id} 
                                            checked={profile.health_conditions.includes(condition.id)} 
                                            onCheckedChange={() => handleHealthConditionChange(condition.id)}
                                        />
                                        <Label htmlFor={condition.id} className="font-normal">{condition.label}</Label>
                                    </div>
                                ))}
                            </div>
                             <div className="flex items-center space-x-2 mt-2">
                                <Checkbox 
                                    id="none" 
                                    checked={profile.health_conditions.length === 0} 
                                    onCheckedChange={() => setProfile(p => ({...p, health_conditions: []}))}
                                />
                                <Label htmlFor="none" className="font-normal">None</Label>
                            </div>
                        </div>
                        
                        <div>
                            <Label>Activity Level</Label>
                            <Select value={profile.activity_level} onValueChange={(value) => setProfile(p => ({...p, activity_level: value}))}>
                                <SelectTrigger>
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="sedentary">Sedentary (little to no exercise)</SelectItem>
                                    <SelectItem value="light">Light (light exercise/sports 1-3 days/week)</SelectItem>
                                    <SelectItem value="moderate">Moderate (moderate exercise/sports 3-5 days/week)</SelectItem>
                                    <SelectItem value="active">Active (hard exercise/sports 6-7 days a week)</SelectItem>
                                    <SelectItem value="very_active">Very Active (very hard exercise & physical job)</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        <div className="pt-4">
                            <Button type="submit" className="w-full bg-gradient-to-r from-emerald-500 to-cyan-600" disabled={loading}>
                                {loading ? "Saving..." : "Save Profile"}
                            </Button>
                        </div>
                    </form>
                </CardContent>
            </Card>
        </motion.div>
    );
}